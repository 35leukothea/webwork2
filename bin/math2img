#!/usr/local/bin/perl

use strict;
use warnings;
use IPC::Open2;

use constant HEADER => <<EOF;
% BEGIN HEADER
\\documentclass{article}
\\begin{document}
\\huge
\\pagestyle{empty}
% END HEADER
EOF
use constant FOOTER => <<EOF;
% BEGIN FOOTER
\\end{document}
% END FOOTER
EOF

my $TEX      = "pip_latex";
my $DVIPS    = "pip -o -i dvips -E -q -o -.eps -.dvi";
my $PSTOIMG  = "pip -o -i pstoimg -antialias -out -.png -quiet -transparent -type png -";

my $imageFile = shift @ARGV;

local (*TEXOUT, *IMAGEIN);
my $pid = open2(\*IMAGEIN, \*TEXOUT, "$TEX | $DVIPS | $PSTOIMG") or exit 1;
print TEXOUT HEADER, <STDIN>, FOOTER or exit 2;
close TEXOUT;
open IMAGEOUT, ">", $imageFile or exit 3;
print IMAGEOUT <IMAGEIN> or exit 4;
close IMAGEOUT;
close IMAGEIN;
waitpid $pid, 0;
